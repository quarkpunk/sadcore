import{x as ae,S as R,r as _,V as le,W as Y,_ as H,J as ee,d as v,e as i,h as r,k as y,t as T,j as F,g as te,O as ne,K as j,L as re,z as se,A as ce,M as ie,p as J,X,f as d,a as ue,P as de,b as me,c as pe,G as fe,Y as O,w as N,F as q,i as Q,l as he,B as z,T as ve,n as ge}from"./main-BUvHvxLs.js";import{Y as _e}from"./v3-infinite-loading.es-CEfPvyom.js";import{a as ke,b as ye,d as Me}from"./date-CfY51IFt.js";import{C as xe}from"./CardContent-odkx8Cti.js";import"./Chip-Nzc7Cizh.js";function we(o,s){const u=ae(),n=R(),a=_([]),m=_(!1),g=_(!1),f=_(!1),w=_(!0),S=_(!1);let h=null;const C=async(t=null)=>{m.value=!0;try{const e=await Y.get(`/api/chat/${o}/messages`);if(e.data){const c=e.data.reverse();a.value=c}e.status==204&&(a.value=[]),m.value=!1}catch(e){console.error("failed fetch messages:",e),m.value=!1}},E=async t=>{f.value=!0;try{const e=await Y.post(`/api/chat/${o}`,t);if(!e||!e.data||!e.data.id_tmp||!e.data.chat)return!1;const c={_id:e.data.id_tmp,chat:e.data.chat,content:t,created:Date.now(),me:!0,readed:!1,local:!0};return a.value.push(c),!0}catch(e){return P(tmpMessage._id,"error"),console.error(e),!1}finally{f.value=!1}},k=t=>{f.value=!0,console.log("content useChat: ",t);const e=Date.now(),c={_id:`${e}`,chat:"mock-5140x2480x4610",content:t,created:Date.now(),me:!0,readed:!1,local:!0};return a.value.push(c),V(`${e}`,"delivered",`${e}`,e),f.value=!1,!0},$=async()=>{if(!(g.value||a.value.length==0||!a.value[0].created||S.value)){g.value=!0;try{const e=a.value[0].created;if(!e)return!1;const c=await n.fetchMessagesMore(o,e);if(!c)return!1;const b=c.reverse();return a.value=[...b,...a.value],g.value=!1,!0}catch(e){return console.error(e),g.value=!1,!1}}},D=t=>{t.chat===o&&t.id_tmp&&V(t.id_tmp,"delivered",t._id,t.created)},B=t=>{t.chat===o&&t.id_tmp&&V(t.id_tmp,"error")},M=t=>{t.message&&t.message.chat===o&&K(t.message)},V=(t,e,c=null,b=null)=>{const U=a.value.findIndex(x=>x._id===t);if(U!==-1){const x={...a.value[U],status:e};c&&(x._id=c,x.local=!1),b&&(x.created=b),e==="error"&&(x.error=!0),a.value[U]=x}},P=(t,e)=>{const c=a.value.findIndex(b=>b._id===t);c!==-1&&(a.value[c]={...a.value[c],status:e,error:e==="error"})},L=()=>{n.isReadedMessageChat(o)||(clearTimeout(h),h=null,h=setTimeout(()=>n.readMessage(o),1e3))},K=t=>{if(L(),!t._id&&t.id_tmp){a.value.push(t),s&&setTimeout(s,300);return}a.value.some(c=>c._id===t._id)||a.value.push(t)},W=()=>{u.on("chat-msg-success",D),u.on("chat-msg-error",B),u.on("chat-msg-new",M),console.log("chat ws connect")},G=()=>{u.off("chat-msg-success",D),u.off("chat-msg-error",B),u.off("chat-msg-new",M),console.log("chat ws connect")};return le(()=>{clearTimeout(h),h=null,G()}),W(),L(),{messages:a,loading:m,sending:f,hasMore:w,loadedFull:S,loadingMore:g,sendMessage:E,sendMessageMock:k,fetchMessages:C,fetchMessagesMore:$,handleMessageSuccess:D,handleMessageError:B,handleNewMessage:M}}function Ce(o,s=300,u="smooth"){function n(){!o.value||o.value.scrollHeight-o.value.scrollTop-o.value.clientHeight>=s||o.value.scrollTo({top:o.value.scrollHeight,behavior:u})}function a(){o.value&&o.value.scrollTo({top:o.value.scrollHeight,behavior:"instant"})}return{scrollBottom:n,scrollBottomInstant:a}}const be={class:"chat-header"},Se={class:"subtitle",style:{margin:"auto"},id:"noevents"},$e={__name:"ChatHeader",props:{title:String,imageBase:String,imageSmall:String,onClickImage:Function,onClickTitle:Function},setup(o){const s=o;return(u,n)=>{const a=ee("Icon-Arrow-Left");return i(),v("div",be,[r("div",{class:"button",onClick:n[0]||(n[0]=m=>u.$router.back())},[y(a,{width:20,height:20,color:"var(--color-icon)",style:{margin:"auto"}})]),r("div",{class:"row flex",onClick:n[1]||(n[1]=m=>s.onClickTitle?s.onClickTitle():{})},[r("p",Se,T(s.title),1)]),r("div",{class:"button",onClick:n[2]||(n[2]=m=>s.onClickImage?s.onClickImage():{})},[s.imageBase&&s.imageSmall?(i(),F(ne,{key:0,class:"image",src:s.imageBase,placeholder:s.imageSmall,id:"noevents",cover:""},null,8,["src","placeholder"])):te("",!0)])])}}},Z=H($e,[["__scopeId","data-v-9396f268"]]),Be={class:"chat-input"},Ie=["placeholder"],Te={__name:"ChatInput",props:j({placeholder:{type:String,default:"Input message..."}},{modelValue:{},modelModifiers:{}}),emits:j(["send"],["update:modelValue"]),setup(o,{emit:s}){const u=s,n=re(o,"modelValue"),a=o,m=se(()=>n.value.length>0);function g(w){w.key==="Enter"&&u("send")}function f(w){n.length!=0&&u("send")}return(w,S)=>{const h=ee("Icon-Send");return i(),v("div",Be,[ce(r("input",{placeholder:a.placeholder,"onUpdate:modelValue":S[0]||(S[0]=C=>n.value=C),onKeypress:g},null,40,Ie),[[ie,n.value]]),r("div",{class:"button",onClick:X(f,["prevent"]),onTouchstart:X(f,["prevent"])},[y(h,{class:J(["icon-send",{active:m.value}]),width:25,height:25,style:{margin:"auto"}},null,8,["class"])],32)])}}},Ve=H(Te,[["__scopeId","data-v-2f142ec4"]]),De={class:"button"},Ue={class:"date small",id:"noevents"},Ae={__name:"ChatMessage",props:{text:String,me:Boolean,local:Boolean,created:Number},setup(o){const s=o;return(u,n)=>(i(),v("div",{class:J(["chat-message",{me:s.me,local:s.local}])},[r("div",{class:J(["body",{me:s.me}])},[r("p",De,T(s.text),1),r("p",Ue,T(d(ke)(s.created)),1)],2)],2))}},Fe=H(Ae,[["__scopeId","data-v-821488c9"]]),He={class:"chat-date-mark",id:"noevents"},Le={class:"text"},Ne={__name:"ChatDateMark",props:{date:String},setup(o){const s=o;return(u,n)=>(i(),v("div",He,[r("p",Le,T(s.date),1)]))}},Ee=H(Ne,[["__scopeId","data-v-28a09a2b"]]),Pe={class:"col",style:{height:"100%"}},Ke={key:0,class:"col flex",style:{height:"100%"}},We={key:2,class:"flex col",id:"noevents"},Ge={style:{margin:"auto","text-align":"center",color:"var(--color-gray-500)"}},Oe={key:4,class:"flex col",id:"noevents"},ze={style:{margin:"auto","text-align":"center",color:"var(--color-gray-500)"}},Je={key:1,class:"chat-user"},Ye={class:"mobile-scroll-view flex"},je={key:2,class:"col flex",id:"noselect"},Xe={class:"col gap-20",style:{margin:"auto","text-align":"center",color:"var(--color-gray-500)"}},qe={__name:"Chat",setup(o){const{t:s}=ue(),u=de(),n=pe(),a=ge(),m=R(),g=me(),f=_(""),w=_(null),S=_(null),h=_(null),C=_(!1),E=+new Date,k=n.params.id,$=m.find(k),{scrollBottom:D,scrollBottomInstant:B}=Ce(w),{messages:M,loading:V,sendMessage:P,sendMessageMock:L,fetchMessages:K,fetchMessagesMore:W}=we(k,D),G=se(()=>M.value.length==0?[]:ye(M.value)),t=async l=>{try{l.loading();const p=await W();if(console.log("chat messages load: ",k),!p){l.complete(),console.log("chat messages loaded: ",k);return}l.loaded()}catch{l.error()}},e=async l=>{m.updateChatPreviewLocal(k,l),await O(),B()},c=async()=>{if(f.value.trim())try{const l=f.value;if(f.value="",g.mode.mock){L(l)&&await e(l);return}await P(l)&&await e(l)}catch(l){console.error("error send:",l)}};function b(){C.value=!1}async function U(){h.value||(h.value=await m.fetchUser(k)),C.value=h.value!=null&&h.value!=null}async function x(l){switch(l){case"delete":await m.delete(k)&&a.push("/chats");break;case"delete_report":a.push(`/report?route=chat&id=${k}&delete=true`);break}}function oe(){u.open("user-delete",{text:s("modals.chatDelete"),icon:"Icon-Heart",image:$.user.photo?.base||null,textDeleteAndReport:s("button.deleteAndReport"),textDelete:s("button.deleteJust"),textCancel:s("button.cancel")},{accept:x,close:()=>{}})}return fe(async()=>{if(g.mode.mock){console.log("chat: mock example"),B(),await O();return}await K(),B(),await O()}),(l,p)=>(i(),v("div",Pe,[y(ve,{name:"t-slide-up"},{default:N(()=>[!C.value&&d(M)&&d(g).state.isOnline?(i(),v("div",Ke,[d($)?(i(),F(Z,{key:0,title:d($).user.name,"image-base":d($).user.photo?.base,"image-small":d($).user.photo?.small,onClickImage:U},null,8,["title","image-base","image-small"])):(i(),F(Z,{key:1,title:"..."})),d(V)?(i(),v("div",We,[r("div",Ge,[r("p",null,T(l.$t("status.loading"))+"...",1)])])):!d(V)&&d(M).length>0?(i(),v("div",{key:3,ref_key:"scroller",ref:w,id:"results",style:{padding:"0px 10px"},class:"mobile-scroll-view flex"},[!d(g).mode.mock&&d(M).length>=40?(i(),F(d(_e),{key:0,target:"#results",top:"",identifier:E,onInfinite:t},{complete:N(()=>[...p[2]||(p[2]=[r("div",null,null,-1)])]),error:N(()=>[...p[3]||(p[3]=[r("div",null,"Error",-1)])]),_:1})):te("",!0),(i(!0),v(q,null,Q(G.value,I=>(i(),v("div",{key:I.dateKey},[y(Ee,{date:d(Me)(I.date)},null,8,["date"]),(i(!0),v(q,null,Q(I.messages,A=>(i(),F(Fe,{key:A._id,text:A.content,me:A.me,created:A.created,local:A.local},null,8,["text","me","created","local"]))),128))]))),128)),r("div",{id:"chat-bottom",ref_key:"scrollerBottom",ref:S},null,512)],512)):(i(),v("div",Oe,[r("div",ze,[r("p",null,T(l.$t("pages.chats.empty")),1),r("p",null,T(l.$t("pages.chats.placeholder")),1)])])),y(Ve,{modelValue:f.value,"onUpdate:modelValue":p[0]||(p[0]=I=>f.value=I),placeholder:l.$t("pages.chat.input"),onSend:c},null,8,["modelValue","placeholder"])])):C.value&&h.value&&d(g).state.isOnline?(i(),v("div",Je,[r("div",Ye,[y(xe,{user:h.value,open:"",showButtonClose:!1,showButtonReport:!1},null,8,["user"])]),y(he,null,{default:N(()=>[y(z,{text:l.$t("button.back"),flex:"",onClick:b},null,8,["text"]),y(z,{text:l.$t("button.delete"),type:"error",flex:"",onClick:oe},null,8,["text"])]),_:1})])):(i(),v("div",je,[r("div",Xe,[p[4]||(p[4]=r("p",null,"No network connection",-1)),y(z,{text:d(s)("button.back"),onClick:p[1]||(p[1]=I=>l.$router.push("/chats"))},null,8,["text"])])]))]),_:1})]))}},st=H(qe,[["__scopeId","data-v-95071b0c"]]);export{st as default};
