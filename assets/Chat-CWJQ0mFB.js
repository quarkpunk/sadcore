import{s as te,O as X,r as g,P as se,Q as z,_ as F,E as Z,c as v,d as r,g as n,j as k,t as T,i as U,f as R,G as J,H as oe,v as ee,x as ae,J as le,n as W,e as p,a as ne,M as re,b as ce,R as ie,D as ue,S as j,w as E,F as Q,h as Y,k as de,B as O,T as me,z as pe}from"./main-FXtvOfZS.js";import{Y as fe}from"./v3-infinite-loading.es-CWirMWiL.js";import{a as ve,b as he,d as ge}from"./date-B-yAhBXo.js";import{u as _e}from"./dating-CNWe_MOS.js";import{I as ye}from"./Image-CgMhDWjt.js";import{C as ke}from"./CardContent-DjV8-bz5.js";import"./Chip-BpkyG-27.js";function xe(s,e){const i=te(),l=X(),a=g([]),m=g(!1),_=g(!1),h=g(!1),w=g(!0),$=g(!1);let f=null;const M=async(t=null)=>{m.value=!0;try{const o=await z.get(`/api/chat/${s}/messages`);if(o.data){const u=o.data.reverse();a.value=u}o.status==204&&(a.value=[]),m.value=!1}catch(o){console.error("failed fetch messages:",o),m.value=!1}},L=async t=>{h.value=!0;try{const o=await z.post(`/api/chat/${s}`,t);if(!o||!o.data||!o.data.id_tmp||!o.data.chat)return!1;const u={_id:o.data.id_tmp,chat:o.data.chat,content:t,created:Date.now(),me:!0,readed:!1,local:!0};return a.value.push(u),!0}catch(o){return N(tmpMessage._id,"error"),console.error(o),!1}finally{h.value=!1}},y=async()=>{if(!(_.value||a.value.length==0||!a.value[0].created||$.value)){_.value=!0;try{const o=a.value[0].created;if(!o)return!1;const u=await l.fetchMessagesMore(s,o);if(!u)return!1;const S=u.reverse();return a.value=[...S,...a.value],_.value=!1,!0}catch(o){return console.error(o),_.value=!1,!1}}},x=t=>{t.chat===s&&t.id_tmp&&b(t.id_tmp,"delivered",t._id,t.created)},V=t=>{t.chat===s&&t.id_tmp&&b(t.id_tmp,"error")},B=t=>{t.message&&t.message.chat===s&&P(t.message)},b=(t,o,u=null,S=null)=>{const D=a.value.findIndex(C=>C._id===t);if(D!==-1){const C={...a.value[D],status:o};u&&(C._id=u,C.local=!1),S&&(C.created=S),o==="error"&&(C.error=!0),a.value[D]=C}},N=(t,o)=>{const u=a.value.findIndex(S=>S._id===t);u!==-1&&(a.value[u]={...a.value[u],status:o,error:o==="error"})},A=()=>{l.isReadedMessageChat(s)||(clearTimeout(f),f=null,f=setTimeout(()=>l.readMessage(s),1e3))},P=t=>{if(A(),!t._id&&t.id_tmp){a.value.push(t),e&&setTimeout(e,300);return}a.value.some(u=>u._id===t._id)||a.value.push(t)},G=()=>{i.on("chat-msg-success",x),i.on("chat-msg-error",V),i.on("chat-msg-new",B),console.log("chat ws connect")},K=()=>{i.off("chat-msg-success",x),i.off("chat-msg-error",V),i.off("chat-msg-new",B),console.log("chat ws connect")};return se(()=>{clearTimeout(f),f=null,K()}),G(),A(),{messages:a,loading:m,sending:h,hasMore:w,loadedFull:$,loadingMore:_,sendMessage:L,fetchMessages:M,fetchMessagesMore:y,handleMessageSuccess:x,handleMessageError:V,handleNewMessage:B}}function Ce(s,e=300,i="smooth"){function l(){!s.value||s.value.scrollHeight-s.value.scrollTop-s.value.clientHeight>=e||s.value.scrollTo({top:s.value.scrollHeight,behavior:i})}function a(){s.value&&s.value.scrollTo({top:s.value.scrollHeight,behavior:"instant"})}return{scrollBottom:l,scrollBottomInstant:a}}const Me={class:"chat-header"},be={class:"subtitle",style:{margin:"auto"},id:"noevents"},Se={__name:"ChatHeader",props:{title:String,imageBase:String,imageSmall:String,onClickImage:Function,onClickTitle:Function},setup(s){const e=s;return(i,l)=>{const a=Z("Icon-Arrow-Left");return r(),v("div",Me,[n("div",{class:"button",onClick:l[0]||(l[0]=m=>i.$router.back())},[k(a,{width:20,height:20,color:"var(--color-icon)",style:{margin:"auto"}})]),n("div",{class:"row flex",onClick:l[1]||(l[1]=m=>e.onClickTitle?e.onClickTitle():{})},[n("p",be,T(e.title),1)]),n("div",{class:"button",onClick:l[2]||(l[2]=m=>e.onClickImage?e.onClickImage():{})},[e.imageBase&&e.imageSmall?(r(),U(ye,{key:0,class:"image",src:e.imageBase,placeholder:e.imageSmall,id:"noevents",cover:""},null,8,["src","placeholder"])):R("",!0)])])}}},q=F(Se,[["__scopeId","data-v-9396f268"]]),we={class:"chat-input"},$e=["placeholder"],Be={__name:"ChatInput",props:J({placeholder:{type:String,default:"Ведите сообщение..."}},{modelValue:{},modelModifiers:{}}),emits:J(["send"],["update:modelValue"]),setup(s,{emit:e}){const i=e,l=oe(s,"modelValue"),a=s,m=ee(()=>l.value.length>0);function _(w){w.key==="Enter"&&i("send")}function h(){l.length!=0&&i("send")}return(w,$)=>{const f=Z("Icon-Send");return r(),v("div",we,[ae(n("input",{placeholder:a.placeholder,"onUpdate:modelValue":$[0]||($[0]=M=>l.value=M),onKeypress:_},null,40,$e),[[le,l.value]]),n("div",{class:"button",onClick:h},[k(f,{class:W(["icon-send",{active:m.value}]),width:25,height:25,style:{margin:"auto"}},null,8,["class"])])])}}},Ie=F(Be,[["__scopeId","data-v-fdcae767"]]),Te={class:"button"},Ve={class:"date small",id:"noevents"},De={__name:"ChatMessage",props:{text:String,me:Boolean,local:Boolean,created:Number},setup(s){const e=s;return(i,l)=>(r(),v("div",{class:W(["chat-message",{me:e.me,local:e.local}])},[n("div",{class:W(["body",{me:e.me}])},[n("p",Te,T(e.text),1),n("p",Ve,T(p(ve)(e.created)),1)],2)],2))}},He=F(De,[["__scopeId","data-v-821488c9"]]),Ue={class:"chat-date-mark",id:"noevents"},Fe={class:"text"},Ne={__name:"ChatDateMark",props:{date:String},setup(s){const e=s;return(i,l)=>(r(),v("div",Ue,[n("p",Fe,T(e.date),1)]))}},Ae=F(Ne,[["__scopeId","data-v-28a09a2b"]]),Ee={class:"col",style:{height:"100%"}},Le={key:0,class:"col flex",style:{height:"100%"}},Pe={key:2,class:"flex col",id:"noevents"},Ge={key:4,class:"flex col",id:"noevents"},Ke={style:{margin:"auto","text-align":"center",color:"var(--color-gray-500)"}},Oe={key:1,class:"chat-user"},We={class:"mobile-scroll-view flex"},ze={key:2,class:"col flex",id:"noselect"},Je={class:"col gap-20",style:{margin:"auto","text-align":"center",color:"var(--color-gray-500)"}},je={__name:"Chat",setup(s){const{t:e}=ne(),i=re(),l=ie(),a=pe(),m=X(),_=ce();_e();const h=g(""),w=g(null),$=g(null),f=g(null),M=g(!1),L=+new Date,y=l.params.id,x=m.find(y),{scrollBottom:V,scrollBottomInstant:B}=Ce(w),{messages:b,loading:N,sendMessage:A,fetchMessages:P,fetchMessagesMore:G}=xe(y,V),K=ee(()=>b.value.length==0?[]:he(b.value)),t=async c=>{try{c.loading();const d=await G();if(console.log("chat messages load: ",y),!d){c.complete(),console.log("chat messages loaded: ",y);return}c.loaded()}catch{c.error()}},o=async()=>{if(h.value.trim())try{const c=h.value;h.value="",await A(c)&&(m.updateChatPreviewLocal(y,c),await j(),B())}catch(c){console.error("error send:",c)}};function u(){M.value=!1}async function S(){f.value||(f.value=await m.fetchUser(y)),M.value=f.value!=null&&f.value!=null}async function D(c){switch(c){case"delete":await m.delete(y)&&a.push("/chats");break;case"delete_report":a.push(`/report?route=chat&id=${y}&delete=true`);break}}function C(){i.open("user-delete",{text:e("modals.chatDelete"),icon:"Icon-Heart",image:x.user.photo?.base||null,textDeleteAndReport:e("button.deleteAndReport"),textDelete:e("button.deleteJust"),textCancel:e("button.cancel")},{accept:D,close:()=>{}})}return ue(async()=>{await P(),B(),await j()}),(c,d)=>(r(),v("div",Ee,[k(me,{name:"t-slide-up"},{default:E(()=>[!M.value&&p(b)&&p(_).state.isOnline?(r(),v("div",Le,[p(x)?(r(),U(q,{key:0,title:p(x).user.name,"image-base":p(x).user.photo?.base,"image-small":p(x).user.photo?.small,onClickImage:S},null,8,["title","image-base","image-small"])):(r(),U(q,{key:1,title:"..."})),p(N)?(r(),v("div",Pe,[...d[2]||(d[2]=[n("div",{style:{margin:"auto","text-align":"center",color:"var(--color-gray-500)"}},[n("p",null,"Загрузка...")],-1)])])):!p(N)&&p(b).length>0?(r(),v("div",{key:3,ref_key:"scroller",ref:w,id:"results",style:{padding:"0px 10px"},class:"mobile-scroll-view flex"},[p(b).length>=40?(r(),U(p(fe),{key:0,target:"#results",top:"",identifier:L,onInfinite:t},{complete:E(()=>[...d[3]||(d[3]=[n("div",null,null,-1)])]),error:E(()=>[...d[4]||(d[4]=[n("div",null,"Error",-1)])]),_:1})):R("",!0),(r(!0),v(Q,null,Y(K.value,I=>(r(),v("div",{key:I.dateKey},[k(Ae,{date:p(ge)(I.date)},null,8,["date"]),(r(!0),v(Q,null,Y(I.messages,H=>(r(),U(He,{key:H._id,text:H.content,me:H.me,created:H.created,local:H.local},null,8,["text","me","created","local"]))),128))]))),128)),n("div",{id:"chat-bottom",ref_key:"scrollerBottom",ref:$},null,512)],512)):(r(),v("div",Ge,[n("div",Ke,[n("p",null,T(c.$t("pages.chats.empty")),1),n("p",null,T(c.$t("pages.chats.placeholder")),1)])])),k(Ie,{modelValue:h.value,"onUpdate:modelValue":d[0]||(d[0]=I=>h.value=I),placeholder:c.$t("pages.chat.input"),onSend:o},null,8,["modelValue","placeholder"])])):M.value&&f.value&&p(_).state.isOnline?(r(),v("div",Oe,[n("div",We,[k(ke,{user:f.value,open:"",showButtonClose:!1,showButtonReport:!1},null,8,["user"])]),k(de,null,{default:E(()=>[k(O,{text:c.$t("button.back"),flex:"",onClick:u},null,8,["text"]),k(O,{text:c.$t("button.delete"),type:"error",flex:"",onClick:C},null,8,["text"])]),_:1})])):(r(),v("div",ze,[n("div",Je,[d[5]||(d[5]=n("p",null,"No network connection",-1)),k(O,{text:p(e)("button.back"),onClick:d[1]||(d[1]=I=>c.$router.push("/chats"))},null,8,["text"])])]))]),_:1})]))}},tt=F(je,[["__scopeId","data-v-ae47ed1c"]]);export{tt as default};
